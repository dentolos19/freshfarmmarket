@model FreshFarmMarket.Models.AuditLogListViewModel
@{
  ViewData["Title"] = "Audit Logs";
}

<div class="container-fluid py-4">
  <div class="d-flex justify-content-between align-items-center mb-4">
    <h1 class="h3 mb-0">üìã Audit Logs</h1>
    <a asp-action="ExportCsv" asp-route-SearchTerm="@Model.Filter.SearchTerm" asp-route-UserId="@Model.Filter.UserId" asp-route-Severity="@Model.Filter.Severity" asp-route-StartDate="@Model.Filter.StartDate?.ToString("yyyy-MM-dd")" asp-route-EndDate="@Model.Filter.EndDate?.ToString("yyyy-MM-dd")" asp-route-ActionType="@Model.Filter.ActionType" class="btn btn-outline-success">
      <span>‚¨áÔ∏è</span> Export CSV
    </a>
  </div>

  <div class="card mb-4 shadow-sm">
    <div class="card-header bg-light">
      <strong>Filters</strong>
    </div>
    <div class="card-body">
      <form method="get" asp-action="AuditLogs">
        <div class="row g-3">
          <div class="col-md-3">
            <label class="form-label">Search</label>
            <input type="text" class="form-control" name="SearchTerm" value="@Model.Filter.SearchTerm" placeholder="Action, email, or IP...">
          </div>
          <div class="col-md-2">
            <label class="form-label">User</label>
            <select class="form-select" name="UserId">
              <option value="">All Users</option>
              @foreach (var user in (dynamic)ViewBag.Users)
              {
                <option value="@user.Id" selected="@(Model.Filter.UserId == user.Id)">@user.Email</option>
              }
            </select>
          </div>
          <div class="col-md-2">
            <label class="form-label">Severity</label>
            <select class="form-select" name="Severity">
              <option value="">All</option>
              <option value="0" selected="@(Model.Filter.Severity == FreshFarmMarket.Entities.AuditLogSeverity.Info)">Info</option>
              <option value="1" selected="@(Model.Filter.Severity == FreshFarmMarket.Entities.AuditLogSeverity.Warning)">Warning</option>
              <option value="2" selected="@(Model.Filter.Severity == FreshFarmMarket.Entities.AuditLogSeverity.Critical)">Critical</option>
            </select>
          </div>
          <div class="col-md-2">
            <label class="form-label">Action Type</label>
            <select class="form-select" name="ActionType">
              <option value="">All Actions</option>
              @foreach (var actionType in (List<string>)ViewBag.ActionTypes)
              {
                <option value="@actionType" selected="@(Model.Filter.ActionType == actionType)">@actionType</option>
              }
            </select>
          </div>
          <div class="col-md-3">
            <label class="form-label">Date Range</label>
            <div class="input-group">
              <input type="date" class="form-control" name="StartDate" value="@Model.Filter.StartDate?.ToString("yyyy-MM-dd")">
              <span class="input-group-text">to</span>
              <input type="date" class="form-control" name="EndDate" value="@Model.Filter.EndDate?.ToString("yyyy-MM-dd")">
            </div>
          </div>
        </div>
        <div class="mt-3">
          <button type="submit" class="btn btn-primary">Apply Filters</button>
          <a asp-action="AuditLogs" class="btn btn-outline-secondary">Clear</a>
        </div>
      </form>
    </div>
  </div>

  <div class="card shadow-sm">
    <div class="card-header bg-light d-flex justify-content-between align-items-center">
      <span>Showing @Model.Logs.Count of @Model.TotalCount logs</span>
      <div>
        <label class="me-2">Page Size:</label>
        <select class="form-select form-select-sm d-inline-block w-auto" onchange="changePageSize(this.value)">
          <option value="10" selected="@(Model.PageSize == 10)">10</option>
          <option value="25" selected="@(Model.PageSize == 25)">25</option>
          <option value="50" selected="@(Model.PageSize == 50)">50</option>
          <option value="100" selected="@(Model.PageSize == 100)">100</option>
        </select>
      </div>
    </div>
    <div class="table-responsive">
      <table class="table table-hover table-striped mb-0">
        <thead class="table-dark">
          <tr>
            <th>ID</th>
            <th>Timestamp</th>
            <th>User</th>
            <th>Action</th>
            <th>Severity</th>
            <th>IP Address</th>
            <th>Endpoint</th>
            <th>Details</th>
          </tr>
        </thead>
        <tbody>
          @if (Model.Logs.Count == 0)
          {
            <tr>
              <td colspan="8" class="text-center text-muted py-4">No audit logs found.</td>
            </tr>
          }
          else
          {
            @foreach (var log in Model.Logs)
            {
              <tr>
                <td><code>@log.Id</code></td>
                <td>
                  <small>@log.Timestamp.ToString("yyyy-MM-dd")</small><br>
                  <small class="text-muted">@log.Timestamp.ToString("HH:mm:ss")</small>
                </td>
                <td>
                  <span title="@log.UserId">@log.UserEmail</span>
                </td>
                <td>@log.Action</td>
                <td>
                  @switch (log.Severity)
                  {
                    case FreshFarmMarket.Entities.AuditLogSeverity.Info:
                      <span class="badge bg-info">Info</span>
                      break;
                    case FreshFarmMarket.Entities.AuditLogSeverity.Warning:
                      <span class="badge bg-warning text-dark">Warning</span>
                      break;
                    case FreshFarmMarket.Entities.AuditLogSeverity.Critical:
                      <span class="badge bg-danger">Critical</span>
                      break;
                  }
                </td>
                <td><code>@(log.IpAddress ?? "-")</code></td>
                <td><small>@(log.Endpoint ?? "-")</small></td>
                <td>
                  @if (!string.IsNullOrEmpty(log.UserAgent) || !string.IsNullOrEmpty(log.AdditionalData))
                  {
                    <button type="button" class="btn btn-sm btn-outline-secondary" data-bs-toggle="modal" data-bs-target="#logModal-@log.Id">
                      View
                    </button>

                    <div class="modal fade" id="logModal-@log.Id" tabindex="-1">
                      <div class="modal-dialog modal-lg">
                        <div class="modal-content">
                          <div class="modal-header">
                            <h5 class="modal-title">Log Details #@log.Id</h5>
                            <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                          </div>
                          <div class="modal-body">
                            <dl class="row">
                              <dt class="col-sm-3">User Agent</dt>
                              <dd class="col-sm-9"><code class="text-wrap">@(log.UserAgent ?? "N/A")</code></dd>

                              <dt class="col-sm-3">Additional Data</dt>
                              <dd class="col-sm-9">
                                <pre class="mb-0">@(log.AdditionalData ?? "N/A")</pre>
                              </dd>
                            </dl>
                          </div>
                        </div>
                      </div>
                    </div>
                  }
                  else
                  {
                    <span class="text-muted">-</span>
                  }
                </td>
              </tr>
            }
          }
        </tbody>
      </table>
    </div>

    @if (Model.TotalPages > 1)
    {
      <div class="card-footer">
        <nav aria-label="Audit log pagination">
          <ul class="pagination justify-content-center mb-0">
            <li class="page-item @(Model.CurrentPage == 1 ? "disabled" : "")">
              <a class="page-link" asp-action="AuditLogs" asp-route-Page="@(Model.CurrentPage - 1)" asp-route-PageSize="@Model.PageSize" asp-route-SearchTerm="@Model.Filter.SearchTerm" asp-route-UserId="@Model.Filter.UserId" asp-route-Severity="@Model.Filter.Severity" asp-route-StartDate="@Model.Filter.StartDate?.ToString("yyyy-MM-dd")" asp-route-EndDate="@Model.Filter.EndDate?.ToString("yyyy-MM-dd")" asp-route-ActionType="@Model.Filter.ActionType">Previous</a>
            </li>

            @{
              var startPage = Math.Max(1, Model.CurrentPage - 2);
              var endPage = Math.Min(Model.TotalPages, Model.CurrentPage + 2);
            }

            @if (startPage > 1)
            {
              <li class="page-item">
                <a class="page-link" asp-action="AuditLogs" asp-route-Page="1" asp-route-PageSize="@Model.PageSize" asp-route-SearchTerm="@Model.Filter.SearchTerm" asp-route-UserId="@Model.Filter.UserId" asp-route-Severity="@Model.Filter.Severity" asp-route-StartDate="@Model.Filter.StartDate?.ToString("yyyy-MM-dd")" asp-route-EndDate="@Model.Filter.EndDate?.ToString("yyyy-MM-dd")" asp-route-ActionType="@Model.Filter.ActionType">1</a>
              </li>
              @if (startPage > 2)
              {
                <li class="page-item disabled"><span class="page-link">...</span></li>
              }
            }

            @for (var i = startPage; i <= endPage; i++)
            {
              <li class="page-item @(i == Model.CurrentPage ? "active" : "")">
                <a class="page-link" asp-action="AuditLogs" asp-route-Page="@i" asp-route-PageSize="@Model.PageSize" asp-route-SearchTerm="@Model.Filter.SearchTerm" asp-route-UserId="@Model.Filter.UserId" asp-route-Severity="@Model.Filter.Severity" asp-route-StartDate="@Model.Filter.StartDate?.ToString("yyyy-MM-dd")" asp-route-EndDate="@Model.Filter.EndDate?.ToString("yyyy-MM-dd")" asp-route-ActionType="@Model.Filter.ActionType">@i</a>
              </li>
            }

            @if (endPage < Model.TotalPages)
            {
              @if (endPage < Model.TotalPages - 1)
              {
                <li class="page-item disabled"><span class="page-link">...</span></li>
              }
              <li class="page-item">
                <a class="page-link" asp-action="AuditLogs" asp-route-Page="@Model.TotalPages" asp-route-PageSize="@Model.PageSize" asp-route-SearchTerm="@Model.Filter.SearchTerm" asp-route-UserId="@Model.Filter.UserId" asp-route-Severity="@Model.Filter.Severity" asp-route-StartDate="@Model.Filter.StartDate?.ToString("yyyy-MM-dd")" asp-route-EndDate="@Model.Filter.EndDate?.ToString("yyyy-MM-dd")" asp-route-ActionType="@Model.Filter.ActionType">@Model.TotalPages</a>
              </li>
            }

            <li class="page-item @(Model.CurrentPage == Model.TotalPages ? "disabled" : "")">
              <a class="page-link" asp-action="AuditLogs" asp-route-Page="@(Model.CurrentPage + 1)" asp-route-PageSize="@Model.PageSize" asp-route-SearchTerm="@Model.Filter.SearchTerm" asp-route-UserId="@Model.Filter.UserId" asp-route-Severity="@Model.Filter.Severity" asp-route-StartDate="@Model.Filter.StartDate?.ToString("yyyy-MM-dd")" asp-route-EndDate="@Model.Filter.EndDate?.ToString("yyyy-MM-dd")" asp-route-ActionType="@Model.Filter.ActionType">Next</a>
            </li>
          </ul>
        </nav>
      </div>
    }
  </div>
</div>

@section Scripts {
  <script>
    function changePageSize(size) {
      const url = new URL(window.location.href);
      url.searchParams.set('PageSize', size);
      url.searchParams.set('Page', '1');
      window.location.href = url.toString();
    }
  </script>
}
